<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Firebase P2P Chat - Two Tabs Fix</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif;}
  body{background:#f0f2f5;display:flex;justify-content:center;align-items:center;height:100vh;}
  .app-container{display:flex;flex-direction:column;width:100%;max-width:480px;height:100vh;overflow:hidden;background:#fff;}
  .connection-panel{padding:15px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;display:flex;flex-direction:column;gap:12px;}
  .connection-status{display:flex;align-items:center;gap:10px;font-weight:600;font-size:0.95rem;}
  .status-dot{width:12px;height:12px;border-radius:50%;background:#ff6b6b;transition:0.3s;}
  .status-dot.connected{background:#51cf66;box-shadow:0 0 8px rgba(81,207,102,0.5);}
  .connection-controls{display:flex;gap:8px;flex-wrap:wrap;}
  .username-input,.message-input,.connection-input{padding:10px 12px;border-radius:18px;border:none;outline:none;font-size:0.9rem;flex:1;}
  .btn{padding:10px 15px;border-radius:18px;border:none;cursor:pointer;font-weight:500;transition:0.3s;font-size:0.9rem;}
  .btn.primary{background:#fff;color:#667eea;}
  .btn:hover{opacity:0.85;transform:translateY(-1px);}
  .chat-container{flex:1;display:flex;flex-direction:column;background:#f9fafb;overflow:hidden;position:relative;}
  .messages-container{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px;}
  .message{max-width:80%;padding:10px 14px;border-radius:16px;word-wrap:break-word;position:relative;animation:fadeIn 0.3s ease-in;font-size:0.9rem;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
  .message.own{align-self:flex-end;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-bottom-right-radius:4px;}
  .message.other{align-self:flex-start;background:#e4e6eb;color:#333;border-bottom-left-radius:4px;}
  .message-info{font-size:0.65rem;opacity:0.6;margin-top:3px;}
  .system-message{text-align:center;font-size:0.75rem;color:#666;margin:4px 0;font-style:italic;}
  .input-container{display:flex;gap:6px;padding:10px 8px;background:#fff;border-top:1px solid #ddd;align-items:center;position:sticky;bottom:0;}
  .send-btn{background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:50px;padding:10px 16px;cursor:pointer;font-weight:600;transition:0.3s;flex-shrink:0;}
  .send-btn:disabled{opacity:0.5;cursor:not-allowed;}
  .messages-container::-webkit-scrollbar{width:5px;}
  .messages-container::-webkit-scrollbar-thumb{background:#ccc;border-radius:3px;}
  .notification{position:fixed;top:12px;right:12px;background:#51cf66;color:white;padding:10px 14px;border-radius:10px;box-shadow:0 3px 12px rgba(0,0,0,0.15);transform:translateX(300px);transition:0.3s;z-index:1000;}
  .notification.show{transform:translateX(0);}
</style>
</head>
<body>
<div class="app-container">
  <div class="connection-panel">
    <div class="connection-status">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Disconnected - Ready</span>
    </div>
    <div class="connection-controls">
      <input type="text" id="roomInput" class="connection-input" placeholder="Room name">
      <button class="btn primary" id="connectBtn">Connect</button>
    </div>
  </div>
  <div class="chat-container">
    <div class="messages-container" id="messagesContainer">
      <div class="system-message">🚀 Firebase P2P Chat</div>
    </div>
    <div class="input-container">
      <input type="text" id="usernameInput" class="username-input" placeholder="Your name" value="Anonymous">
      <input type="text" id="messageInput" class="message-input" placeholder="Connect to start..." disabled>
      <button id="sendBtn" class="send-btn" disabled>Send</button>
    </div>
  </div>
</div>
<div class="notification" id="notification"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, onValue, set, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import SimplePeer from "https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js";
import CryptoJS from "https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js";
import { marked } from "https://cdnjs.cloudflare.com/ajax/libs/marked/5.0.2/marked.min.js";

const firebaseConfig = {
  apiKey: "AIzaSyB6UHNUKO2Qj3IUgsISxz99BoOQYuGS_vc",
  authDomain: "link-88288.firebaseapp.com",
  projectId: "link-88288",
  storageBucket: "link-88288.appspot.com",
  messagingSenderId: "166586794486",
  appId: "1:166586794486:web:abd1f2dfbbbbfe56ef47d7"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

class FirebaseP2PChat {
  constructor(){
    this.peerMap = {}; // store peers by peerId
    this.username = 'Anonymous';
    this.room = '';
    this.peerId = Math.random().toString(36).substring(2,10);
    this.initElements();
    this.attachEvents();
  }

  initElements(){
    this.roomInput = document.getElementById('roomInput');
    this.connectBtn = document.getElementById('connectBtn');
    this.messagesContainer = document.getElementById('messagesContainer');
    this.usernameInput = document.getElementById('usernameInput');
    this.messageInput = document.getElementById('messageInput');
    this.sendBtn = document.getElementById('sendBtn');
    this.statusDot = document.getElementById('statusDot');
    this.statusText = document.getElementById('statusText');
    this.notification = document.getElementById('notification');
  }

  attachEvents(){
    this.connectBtn.addEventListener('click', ()=>this.connectRoom());
    this.sendBtn.addEventListener('click', ()=>this.sendMessage());
    this.usernameInput.addEventListener('input', e=>this.username = e.target.value.trim() || 'Anonymous');
    this.messageInput.addEventListener('keypress', e=>{if(e.key==='Enter') this.sendMessage();});
  }

  connectRoom(){
    this.room = this.roomInput.value.trim();
    if(!this.room) return alert("Enter room name");

    // Add self to users list
    const userRef = ref(db, `rooms/${this.room}/users/${this.peerId}`);
    set(userRef, this.username);
    window.addEventListener('beforeunload', ()=>remove(userRef));

    // Listen for signals from all peers
    const signalsRef = ref(db, `rooms/${this.room}/signals`);
    onChildAdded(signalsRef, snapshot=>{
      const obj = snapshot.val();
      if(obj.from === this.peerId) return;
      remove(snapshot.ref); // remove used signal
      if(!this.peerMap[obj.from]){
        this.createPeer(obj.from, false); // existing peer, initiator=false
      }
      this.peerMap[obj.from].signal(obj.signal);
    });

    // Listen for new users to connect
    const usersRef = ref(db, `rooms/${this.room}/users`);
    onValue(usersRef, snapshot=>{
      const users = snapshot.val() || {};
      Object.keys(users).forEach(peerId=>{
        if(peerId !== this.peerId && !this.peerMap[peerId]){
          this.createPeer(peerId, true); // new user, initiator=true
        }
      });
    });

    this.updateStatus('Waiting for peers...', false);
  }

  createPeer(peerId, initiator){
    const peer = new SimplePeer({ initiator, trickle: false, config:{iceServers:[{urls:'stun:stun.l.google.com:19302'}]} });
    this.peerMap[peerId] = peer;

    peer.on('signal', data=>{
      push(ref(db, `rooms/${this.room}/signals`), { from: this.peerId, to: peerId, signal: data });
    });

    peer.on('connect', ()=>{
      this.messageInput.disabled = false;
      this.sendBtn.disabled = false;
      this.addSystemMessage(`🎉 Connected to ${peerId}`);
      this.updateStatus('Connected!', true);
    });

    peer.on('data', data=>{
      const msg = JSON.parse(data.toString());
      if(msg.type==='message') this.addMessage(this.decrypt(msg.text), msg.username, false);
    });

    peer.on('close', ()=>{
      this.addSystemMessage(`❌ Disconnected from ${peerId}`);
      delete this.peerMap[peerId];
    });
  }

  sendMessage(){
    const text = this.messageInput.value.trim();
    if(!text) return;
    const msg = { type:'message', text: this.encrypt(text), username: this.username };
    Object.values(this.peerMap).forEach(p=>p.send(JSON.stringify(msg)));
    this.addMessage(text, this.username, true);
    this.messageInput.value = '';
  }

  addMessage(text, username, isOwn){
    const div = document.createElement('div');
    div.className = 'message ' + (isOwn ? 'own':'other');
    div.innerHTML = `<div class="message-bubble">${marked.parseInline(text)}</div>
                     <div class="message-info">${username} • ${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>`;
    this.messagesContainer.appendChild(div);
    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
  }

  addSystemMessage(text){
    const div = document.createElement('div');
    div.className = 'system-message';
    div.textContent = text;
    this.messagesContainer.appendChild(div);
    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
  }

  encrypt(msg){ return CryptoJS.AES.encrypt(msg,'secret-key').toString(); }
  decrypt(cipher){ return CryptoJS.AES.decrypt(cipher,'secret-key').toString(CryptoJS.enc.Utf8); }

  updateStatus(text, connected){
    this.statusText.textContent = text;
    connected ? this.statusDot.classList.add('connected') : this.statusDot.classList.remove('connected');
  }
}

new FirebaseP2PChat();
</script>
</body>
</html>
