<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>P2P Chat - WebRTC</title>
<style>
    * {margin:0; padding:0; box-sizing:border-box;}
    body {font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); height:100vh; display:flex; justify-content:center; align-items:center; overflow:hidden;}
    .app-container {background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); border-radius:20px; box-shadow:0 20px 40px rgba(0,0,0,0.1); width:90%; max-width:900px; height:90vh; display:flex; flex-direction:column; overflow:hidden;}
    .connection-panel {background:linear-gradient(135deg,#667eea,#764ba2); color:white; padding:20px; border-radius:20px 20px 0 0;}
    .connection-status {display:flex; align-items:center; gap:10px; margin-bottom:15px;}
    .status-dot {width:12px; height:12px; border-radius:50%; background:#ff6b6b; transition:all 0.3s ease;}
    .status-dot.connected {background:#51cf66; box-shadow:0 0 10px rgba(81,207,102,0.5);}
    .connection-controls {display:flex; gap:10px; flex-wrap:wrap;}
    .connection-input {flex:1; min-width:200px; padding:10px 15px; border:none; border-radius:15px; background:rgba(255,255,255,0.2); color:white;}
    .connection-input::placeholder {color:rgba(255,255,255,0.7);}
    .btn {padding:10px 20px; border:none; border-radius:15px; cursor:pointer; font-weight:500; transition:all 0.3s ease; background:rgba(255,255,255,0.2); color:white;}
    .btn:hover {background:rgba(255,255,255,0.3); transform:translateY(-2px);}
    .btn.primary {background:rgba(255,255,255,0.9); color:#667eea;}
    .offer-display {margin-top:15px; padding:15px; background:rgba(255,255,255,0.1); border-radius:10px; display:none; position:relative;}
    .offer-text {background:rgba(255,255,255,0.2); border:none; color:white; width:100%; height:80px; padding:10px; border-radius:8px; resize:vertical; font-family:monospace; font-size:12px;}
    .copy-btn {position:absolute; top:5px; right:5px; background:rgba(255,255,255,0.3); border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:12px;}
    .chat-container {flex:1; display:flex; flex-direction:column; min-height:0;}
    .messages-container {flex:1; overflow-y:auto; padding:20px; background:rgba(255,255,255,0.8);}
    .message {margin-bottom:15px; animation:fadeIn 0.3s ease-in;}
    @keyframes fadeIn {from{opacity:0; transform:translateY(10px);}to{opacity:1; transform:translateY(0);}}
    .message.own {text-align:right;}
    .message-bubble {display:inline-block; max-width:70%; padding:12px 16px; border-radius:18px; word-wrap:break-word; position:relative;}
    .message.own .message-bubble {background:linear-gradient(135deg,#667eea,#764ba2); color:white; border-bottom-right-radius:4px;}
    .message:not(.own) .message-bubble {background:#f1f3f5; color:#333; border-bottom-left-radius:4px;}
    .message-info {font-size:0.75rem; opacity:0.7; margin-top:5px;}
    .system-message {text-align:center; color:#666; font-style:italic; font-size:0.9rem; margin:10px 0; opacity:0.8;}
    .input-container {padding:20px; background:rgba(255,255,255,0.9); border-radius:0 0 20px 20px; display:flex; gap:10px;}
    .username-input {flex:0 0 120px; padding:12px; border:2px solid #e9ecef; border-radius:25px; outline:none; font-size:0.9rem; transition:all 0.3s ease;}
    .username-input:focus {border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,0.1);}
    .message-input {flex:1; padding:12px 20px; border:2px solid #e9ecef; border-radius:25px; outline:none; font-size:1rem; transition:all 0.3s ease;}
    .message-input:focus {border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,0.1);}
    .send-btn {background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; padding:12px 24px; border-radius:25px; cursor:pointer; font-size:1rem; transition:all 0.3s ease; box-shadow:0 4px 15px rgba(102,126,234,0.3);}
    .send-btn:hover {transform:translateY(-2px); box-shadow:0 6px 20px rgba(102,126,234,0.4);}
    .send-btn:disabled {opacity:0.5; cursor:not-allowed; transform:none; box-shadow:none;}
    .messages-container::-webkit-scrollbar {width:6px;}
    .messages-container::-webkit-scrollbar-track {background:rgba(255,255,255,0.1);}
    .messages-container::-webkit-scrollbar-thumb {background:rgba(102,126,234,0.3); border-radius:3px;}
    .notification {position:fixed; top:20px; right:20px; background:#51cf66; color:white; padding:15px 20px; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.2); transform:translateX(300px); transition:all 0.3s ease; z-index:1000;}
    .notification.show {transform:translateX(0);}
    @media (max-width:768px) {
        .app-container {width:95%; height:95vh;}
        .connection-controls {flex-direction:column;}
        .connection-input {min-width:auto;}
        .username-input {flex:0 0 80px;}
        .message-bubble {max-width:85%;}
    }
</style>
</head>
<body>
<div class="app-container">
    <div class="connection-panel">
        <div class="connection-status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Disconnected - Ready to connect</span>
        </div>
        <div class="connection-controls">
            <button class="btn primary" id="createRoomBtn">Create Room</button>
            <input type="text" class="connection-input" id="roomCodeInput" placeholder="Enter room code to join...">
            <button class="btn" id="joinRoomBtn">Join Room</button>
        </div>
        <div class="offer-display" id="offerDisplay">
            <textarea class="offer-text" id="offerText" readonly></textarea>
            <button class="copy-btn" id="copyBtn">ðŸ“‹ Copy Code</button>
        </div>
    </div>

    <div class="chat-container">
        <div class="messages-container" id="messagesContainer">
            <div class="system-message">ðŸš€ P2P Chat powered by WebRTC</div>
            <div class="system-message">Create a room or join with a code to start chatting!</div>
        </div>
        <div class="input-container">
            <input type="text" id="usernameInput" class="username-input" placeholder="Your name" value="Anonymous">
            <input type="text" id="messageInput" class="message-input" placeholder="Connect to start messaging..." disabled>
            <button id="sendBtn" class="send-btn" disabled>Send</button>
        </div>
    </div>
</div>

<div class="notification" id="notification"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>
<script>
class P2PChat {
    constructor() {
        this.peer = null;
        this.isInitiator = false;
        this.connected = false;
        this.username = 'Anonymous';

        this.initializeElements();
        this.attachEventListeners();
    }

    initializeElements() {
        this.statusDot = document.getElementById('statusDot');
        this.statusText = document.getElementById('statusText');
        this.createRoomBtn = document.getElementById('createRoomBtn');
        this.joinRoomBtn = document.getElementById('joinRoomBtn');
        this.roomCodeInput = document.getElementById('roomCodeInput');
        this.offerDisplay = document.getElementById('offerDisplay');
        this.offerText = document.getElementById('offerText');
        this.copyBtn = document.getElementById('copyBtn');
        this.messagesContainer = document.getElementById('messagesContainer');
        this.usernameInput = document.getElementById('usernameInput');
        this.messageInput = document.getElementById('messageInput');
        this.sendBtn = document.getElementById('sendBtn');
        this.notification = document.getElementById('notification');
    }

    attachEventListeners() {
        this.createRoomBtn.addEventListener('click', () => this.startConnection(true));
        this.joinRoomBtn.addEventListener('click', () => this.startConnection(false));
        this.copyBtn.addEventListener('click', () => this.copyToClipboard());
        this.sendBtn.addEventListener('click', () => this.sendMessage());
        this.usernameInput.addEventListener('input', e => this.username = e.target.value.trim() || 'Anonymous');
        this.messageInput.addEventListener('keypress', e => {if(e.key==='Enter' && this.connected)this.sendMessage();});
        this.offerText.addEventListener('click', () => this.offerText.select());
    }

    startConnection(isInitiator) {
        this.isInitiator = isInitiator;
        const code = this.roomCodeInput.value.trim();

        if (!isInitiator && !code) return this.showNotification('Please enter a room code', 'error');

        this.updateStatus(isInitiator?'Creating room...':'Joining room...', false);

        this.peer = new SimplePeer({initiator:isInitiator,trickle:false});

        this.peer.on('signal', data => {
            const jsonData = JSON.stringify(data);
            this.offerText.value = jsonData;
            this.offerDisplay.style.display = 'block';
            this.updateStatus(isInitiator?'Room created! Share the code below':'Send this response code back to room creator', false);
        });

        this.peer.on('connect', () => this.onConnection());
        this.peer.on('data', data => this.onMessage(data));
        this.peer.on('error', err => {this.showNotification('Connection error: '+err.message,'error'); this.updateStatus('Connection failed',false);});

        if (!isInitiator) {
            try {
                const signalData = JSON.parse(code);
                this.peer.signal(signalData);
            } catch {
                this.showNotification('Invalid room code format', 'error');
            }
        } else this.createRoomBtn.disabled = true;
    }

    onConnection() {
        this.connected = true;
        this.updateStatus('Connected! You can now chat', true);
        this.messageInput.disabled = false;
        this.sendBtn.disabled = false;
        this.messageInput.placeholder = 'Type your message...';
        this.messageInput.focus();
        this.offerDisplay.style.display = 'none';
        this.addSystemMessage('ðŸŽ‰ Connected! Start chatting...');
        this.showNotification('Successfully connected!', 'success');
    }

    onMessage(data) {
        try {
            const message = JSON.parse(data.toString());
            this.addMessage(message.text, message.username, false);
        } catch {}
    }

    sendMessage() {
        const text = this.messageInput.value.trim();
        if (!text || !this.connected) return;
        const message = {text,text,username:this.username,timestamp:new Date().toISOString()};
        try {
            this.peer.send(JSON.stringify(message));
            this.addMessage(text,this.username,true);
            this.messageInput.value='';
        } catch {this.showNotification('Failed to send message','error');}
    }

    addMessage(text, username, isOwn){
        const div=document.createElement('div');
        div.className=`message ${isOwn?'own':''}`;
        const bubble=document.createElement('div');
        bubble.className='message-bubble';
        bubble.textContent=text;
        const info=document.createElement('div');
        info.className='message-info';
        info.textContent=`${username} â€¢ ${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;
        div.appendChild(bubble); div.appendChild(info);
        this.messagesContainer.appendChild(div);
        this.scrollToBottom();
    }

    addSystemMessage(text){
        const div=document.createElement('div');
        div.className='system-message';
        div.textContent=text;
        this.messagesContainer.appendChild(div);
        this.scrollToBottom();
    }

    updateStatus(text, connected){
        this.statusText.textContent=text;
        if(connected)this.statusDot.classList.add('connected');
        else this.statusDot.classList.remove('connected');
    }

    scrollToBottom(){this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight;}

    async copyToClipboard(){
        try {
            await navigator.clipboard.writeText(this.offerText.value);
            this.showNotification('Room code copied to clipboard!','success');
        } catch {
            this.offerText.select();
            document.execCommand('copy');
            this.showNotification('Room code copied to clipboard!','success');
        }
    }

    showNotification(message,type='info'){
        this.notification.textContent=message;
        this.notification.style.background=type==='error'?'#ff6b6b':'#51cf66';
        this.notification.classList.add('show');
        setTimeout(()=>this.notification.classList.remove('show'),3000);
    }
}

const chat = new P2PChat();
</script>
</body>
</html>
