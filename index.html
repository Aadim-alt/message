<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>P2P Chat - Full Featured</title>
<style>
  /* ---- Base Styles ---- */
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Segoe UI',sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); height:100vh; display:flex; justify-content:center; align-items:center; overflow:hidden; }
  .app-container { background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); border-radius:20px; box-shadow:0 20px 40px rgba(0,0,0,0.1); width:90%; max-width:900px; height:90vh; display:flex; flex-direction:column; overflow:hidden; }
  .connection-panel { background:linear-gradient(135deg,#667eea,#764ba2); color:white; padding:20px; border-radius:20px 20px 0 0; }
  .connection-status { display:flex; align-items:center; gap:10px; margin-bottom:15px; }
  .status-dot { width:12px; height:12px; border-radius:50%; background:#ff6b6b; transition:all 0.3s ease; }
  .status-dot.connected { background:#51cf66; box-shadow:0 0 10px rgba(81,207,102,0.5); }
  .connection-controls { display:flex; gap:10px; flex-wrap:wrap; }
  .connection-input { flex:1; min-width:200px; padding:10px 15px; border:none; border-radius:15px; background:rgba(255,255,255,0.2); color:white; }
  .connection-input::placeholder { color:rgba(255,255,255,0.7); }
  .btn { padding:10px 20px; border:none; border-radius:15px; cursor:pointer; font-weight:500; transition:all 0.3s ease; background:rgba(255,255,255,0.2); color:white; }
  .btn:hover { background:rgba(255,255,255,0.3); transform:translateY(-2px); }
  .btn.primary { background:rgba(255,255,255,0.9); color:#667eea; }
  .chat-container { flex:1; display:flex; flex-direction:column; min-height:0; }
  .messages-container { flex:1; overflow-y:auto; padding:20px; background:rgba(255,255,255,0.8); }
  .message { margin-bottom:15px; animation:fadeIn 0.3s ease-in; position:relative; }
  @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
  .message.own { text-align:right; }
  .message-bubble { display:inline-block; max-width:70%; padding:12px 16px; border-radius:18px; word-wrap:break-word; position:relative; }
  .message.own .message-bubble { background:linear-gradient(135deg,#667eea,#764ba2); color:white; border-bottom-right-radius:4px; }
  .message:not(.own) .message-bubble { background:#f1f3f5; color:#333; border-bottom-left-radius:4px; }
  .message-info { font-size:0.75rem; opacity:0.7; margin-top:5px; }
  .system-message { text-align:center; color:#666; font-style:italic; font-size:0.9rem; margin:10px 0; opacity:0.8; }
  .input-container { padding:20px; background:rgba(255,255,255,0.9); border-radius:0 0 20px 20px; display:flex; gap:10px; }
  .username-input { flex:0 0 120px; padding:12px; border:2px solid #e9ecef; border-radius:25px; outline:none; font-size:0.9rem; transition:all 0.3s ease; }
  .username-input:focus { border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,0.1); }
  .message-input { flex:1; padding:12px 20px; border:2px solid #e9ecef; border-radius:25px; outline:none; font-size:1rem; transition:all 0.3s ease; }
  .message-input:focus { border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,0.1); }
  .send-btn { background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; padding:12px 24px; border-radius:25px; cursor:pointer; font-size:1rem; transition:all 0.3s ease; box-shadow:0 4px 15px rgba(102,126,234,0.3); }
  .send-btn:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(102,126,234,0.4); }
  .send-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; box-shadow:none; }
  .messages-container::-webkit-scrollbar { width:6px; }
  .messages-container::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
  .messages-container::-webkit-scrollbar-thumb { background: rgba(102,126,234,0.3); border-radius:3px; }
  .notification { position:fixed; top:20px; right:20px; background:#51cf66; color:white; padding:15px 20px; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.2); transform:translateX(300px); transition:all 0.3s ease; z-index:1000; }
  .notification.show { transform:translateX(0); }
  @media(max-width:768px){.app-container{width:95%;height:95vh}.connection-controls{flex-direction:column}.connection-input{min-width:auto}.username-input{flex:0 0 80px}.message-bubble{max-width:85%;}}
</style>
</head>
<body>
<div class="app-container">
  <div class="connection-panel">
    <div class="connection-status">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Disconnected - Ready to connect</span>
    </div>
    <div class="connection-controls">
      <button class="btn primary" id="createRoomBtn">Create Room</button>
      <input type="text" class="connection-input" id="roomCodeInput" placeholder="Enter room code to join...">
      <button class="btn" id="joinRoomBtn">Join Room</button>
      <button class="btn" id="pasteJoinerBtn">Paste Joiner Response</button>
    </div>
    <div class="offer-display" id="offerDisplay" style="display:none;">
      <textarea class="offer-text" id="offerText" readonly></textarea>
      <button class="btn" id="copyBtn">Copy Code</button>
      <button class="btn" id="qrBtn">Show QR</button>
      <button class="btn" id="shareBtn">Share</button>
    </div>
  </div>

  <div class="chat-container">
    <div class="messages-container" id="messagesContainer">
      <div class="system-message">ðŸš€ P2P Chat powered by WebRTC</div>
    </div>
    <div class="input-container">
      <input type="text" id="usernameInput" class="username-input" placeholder="Your name" value="Anonymous">
      <input type="text" id="messageInput" class="message-input" placeholder="Connect to start messaging..." disabled>
      <button id="sendBtn" class="send-btn" disabled>Send</button>
    </div>
  </div>
</div>

<div class="notification" id="notification"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/5.0.2/marked.min.js"></script>

<script>
class P2PChat {
  constructor() {
    this.peer = null; this.connected=false; this.username='Anonymous'; this.messages=[]; this.typing=false;
    this.roomCode=''; this.autoReconnectInterval=null;
    this.initializeElements(); this.attachEvents(); this.loadPersistentChat();
  }

  initializeElements(){
    this.statusDot=document.getElementById('statusDot'); this.statusText=document.getElementById('statusText');
    this.createRoomBtn=document.getElementById('createRoomBtn'); this.joinRoomBtn=document.getElementById('joinRoomBtn');
    this.pasteJoinerBtn=document.getElementById('pasteJoinerBtn');
    this.roomCodeInput=document.getElementById('roomCodeInput'); this.offerDisplay=document.getElementById('offerDisplay');
    this.offerText=document.getElementById('offerText'); this.copyBtn=document.getElementById('copyBtn'); 
    this.qrBtn=document.getElementById('qrBtn'); this.shareBtn=document.getElementById('shareBtn');
    this.messagesContainer=document.getElementById('messagesContainer'); this.usernameInput=document.getElementById('usernameInput');
    this.messageInput=document.getElementById('messageInput'); this.sendBtn=document.getElementById('sendBtn');
    this.notification=document.getElementById('notification');
  }

  attachEvents(){
    this.createRoomBtn.addEventListener('click',()=>this.startConnection(true));
    this.joinRoomBtn.addEventListener('click',()=>this.startConnection(false));
    this.pasteJoinerBtn.addEventListener('click',()=>this.pasteJoinerResponse());
    this.copyBtn.addEventListener('click',()=>this.copyCode());
    this.qrBtn.addEventListener('click',()=>this.showQR());
    this.shareBtn.addEventListener('click',()=>this.shareCode());
    this.sendBtn.addEventListener('click',()=>this.sendMessage());
    this.usernameInput.addEventListener('input', e=>this.username=e.target.value.trim()||'Anonymous');
    this.messageInput.addEventListener('keypress', e=>{if(e.key==='Enter'&&this.connected)this.sendMessage();});
  }

  generateRoomCode(){return crypto.randomUUID();}

  startConnection(isInitiator){
    this.isInitiator=isInitiator;
    if(isInitiator) {
        this.roomCode=this.generateRoomCode();
    } else {
        this.roomCode=this.roomCodeInput.value.trim();
        if(!this.roomCode) return this.showNotification('Enter a valid room code','error');
    }

    this.peer = new SimplePeer({ initiator:isInitiator, trickle:false });

    this.peer.on('signal', data => {
        this.offerText.value = JSON.stringify(data);
        this.offerDisplay.style.display = 'block';
        if(isInitiator){
            this.updateStatus('Room created! Share this code with joiner',false);
        } else {
            this.updateStatus('Send this response code back to creator',false);
        }
    });

    this.peer.on('connect', ()=>this.onConnect());
    this.peer.on('data', data=>this.handleData(data));
    this.peer.on('error', err=>{
        this.showNotification('Connection error:'+err.message,'error');
        this.updateStatus('Connection failed',false);
    });

    if(!isInitiator){
        try { this.peer.signal(JSON.parse(this.roomCode)); } 
        catch { return this.showNotification('Invalid room code','error'); }
    }

    this.peer.on('close', ()=>{
        this.connected=false;
        this.updateStatus('Disconnected. Attempting reconnect...',false);
        this.autoReconnectInterval=setTimeout(()=>this.startConnection(isInitiator),3000);
    });
  }

  pasteJoinerResponse(){
    if(!this.isInitiator) return this.showNotification('Only creator uses this','error');
    const answer = prompt('Paste joiner code here:');
    try{
        this.peer.signal(JSON.parse(answer));
        this.updateStatus('Connecting...', false);
    } catch {
        this.showNotification('Invalid code', 'error');
    }
  }

  onConnect(){
    this.connected=true; clearTimeout(this.autoReconnectInterval);
    this.updateStatus('Connected! You can chat',true);
    this.messageInput.disabled=false; this.sendBtn.disabled=false; this.messageInput.placeholder='Type a message...';
    this.addSystemMessage('ðŸŽ‰ Connected!');
  }

  handleData(data){
    let msg=JSON.parse(data.toString());
    if(msg.type==='message'){ this.addMessage(this.decrypt(msg.text), msg.username,false,msg.id); }
    if(msg.type==='typing'){ this.showTyping(msg.username,msg.status); }
    if(msg.type==='read'){ this.markAsRead(msg.id); }
    if(msg.type==='file'){ this.addMessage('[File received]', msg.username,false,msg.id); }
  }

  sendMessage(){
    const text=this.messageInput.value.trim(); if(!text) return;
    const message={type:'message',text:this.encrypt(text),username:this.username,id:this.generateRoomCode()};
    this.peer.send(JSON.stringify(message)); this.addMessage(text,this.username,true,message.id);
    this.messageInput.value=''; this.savePersistentChat();
  }

  encrypt(msg){return CryptoJS.AES.encrypt(msg,'secret-key').toString();}
  decrypt(cipher){return CryptoJS.AES.decrypt(cipher,'secret-key').toString(CryptoJS.enc.Utf8);}

  addMessage(text,username,isOwn,id){
    const div=document.createElement('div'); div.className=`message ${isOwn?'own':''}`; div.dataset.id=id||'';
    const bubble=document.createElement('div'); bubble.className='message-bubble'; bubble.innerHTML=marked.parseInline(text);
    const info=document.createElement('div'); info.className='message-info'; info.textContent=`${username} â€¢ ${this.formatTime()}`;
    div.appendChild(bubble); div.appendChild(info); this.messagesContainer.appendChild(div); this.scrollToBottom();
    if(!isOwn)this.playNotification();
  }

  playNotification(){const audio=new Audio('https://www.myinstants.com/media/sounds/bleep.mp3'); audio.play();}

  showTyping(username,status){/* Typing indicator can go here */ }

  markAsRead(id){/* Read receipt placeholder */ }

  copyCode(){navigator.clipboard.writeText(this.offerText.value).then(()=>this.showNotification('Copied!','success'));}

  showQR(){new QRious({element:this.offerText,value:this.offerText.value,size:250,level:'H'});}

  shareCode(){navigator.share?navigator.share({title:'Join Chat',text:this.offerText.value}).catch(()=>this.copyCode()):this.copyCode();}

  updateStatus(text,connected){this.statusText.textContent=text; connected?this.statusDot.classList.add('connected'):this.statusDot.classList.remove('connected');}
  addSystemMessage(text){const div=document.createElement('div'); div.className='system-message'; div.textContent=text; this.messagesContainer.appendChild(div); this.scrollToBottom();}
  scrollToBottom(){this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight;}
  formatTime(){const d=new Date();return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});}

  savePersistentChat(){localStorage.setItem('chatHistory',JSON.stringify([...this.messagesContainer.querySelectorAll('.message')].map(m=>({text:m.querySelector('.message-bubble').innerHTML,username:m.querySelector('.message-info').textContent}))))}
  loadPersistentChat(){const history=JSON.parse(localStorage.getItem('chatHistory')||'[]'); history.forEach(m=>this.addMessage(m.text,m.username,false));}

  showNotification(msg,type='success'){
    this.notification.textContent=msg;
    this.notification.style.background = type==='error'?'#ff6b6b':'#51cf66';
    this.notification.classList.add('show');
    setTimeout(()=>this.notification.classList.remove('show'),3000);
  }
}

const chatApp=new P2PChat();
</script>
</body>
</html>
